services:
    changedetection:
      image: ghcr.io/dgtlmoon/changedetection.io:latest
      container_name: changedetection
      hostname: changedetection
      dns:
        - 1.1.1.1
        - 1.0.0.1
      networks:
        - traefik_default
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik_default
        - traefik.http.routers.changedectection-https.rule=Host(`${CHANGEDETECTIONIO_HOST}`)
        - traefik.http.routers.changedectection-https.entrypoints=https
        - traefik.http.routers.changedectection-https.tls=true
        - traefik.http.routers.changedectection-https.tls.certresolver=letsencrypt-resolver
        - traefik.http.services.changedectection.loadbalancer.server.port=5000
        - traefik.http.middlewares.cdio-ratelimit.ratelimit.average=100
        - traefik.http.middlewares.cdio-ratelimit.ratelimit.burst=200
        - traefik.http.middlewares.cdio-ratelimit.ratelimit.period=30s
        #- traefik.http.middlewares.cdio-ipwhitelist.ipwhitelist.sourcerange=127.0.0.1/32, 10.0.0.4/32, 123.192.33.140/32, 20.57.166.130/32, 52.175.243.218/32
        #- traefik.http.routers.changedectection-https.middlewares=cdio-ipwhitelist, cdio-ratelimit
        - traefik.http.routers.changedectection-https.middlewares=cdio-ratelimit
      volumes:
        - changedetectionio_data:/datastore
# Configurable proxy list support, see https://github.com/dgtlmoon/changedetection.io/wiki/Proxy-configuration#proxy-list-support
#        - ./proxies.json:/datastore/proxies.json

      environment:
  #        Default listening port, can also be changed with the -p option
        - PORT=5000

  #      - PUID=1000
  #      - PGID=1000
  #
  #       Alternative WebDriver/selenium URL, do not use "'s or 's!
  #      - WEBDRIVER_URL=http://browser-chrome:4444/wd/hub
  #
  #       WebDriver proxy settings webdriver_proxyType, webdriver_ftpProxy, webdriver_noProxy,
  #                                webdriver_proxyAutoconfigUrl, webdriver_autodetect,
  #                                webdriver_socksProxy, webdriver_socksUsername, webdriver_socksVersion, webdriver_socksPassword
  #
  #             https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.proxy
  #       Alternative target "Chrome" Playwright URL, do not use "'s or 's!
  #       "Playwright" is a driver/librarythat allows changedetection to talk to a Chrome or similar browser.
        - PLAYWRIGHT_DRIVER_URL=ws://sockpuppetbrowser:3000
  #
  #       Playwright proxy settings playwright_proxy_server, playwright_proxy_bypass, playwright_proxy_username, playwright_proxy_password
  #
  #             https://playwright.dev/python/docs/api/class-browsertype#browser-type-launch-option-proxy
  #
  #
  #       Alternative Playwright URL, do not use "'s or 's!
  #      - PLAYWRIGHT_DRIVER_URL=ws://playwright-chrome:3000/?stealth=1&--disable-web-security=true
  #
  #       Playwright proxy settings playwright_proxy_server, playwright_proxy_bypass, playwright_proxy_username, playwright_proxy_password
  #
  #             https://playwright.dev/python/docs/api/class-browsertype#browser-type-launch-option-proxy
  #
  #        Plain requests - proxy support example.
  #      - HTTP_PROXY=socks5h://192.168.0.4:3128
  #      - HTTPS_PROXY=socks5h://192.168.0.4:3129
  #
  #        An exclude list (useful for notification URLs above) can be specified by with
  #      - NO_PROXY="localhost,192.168.0.0/24"
  #
  #        Base URL of your changedetection.io install (Added to the notification alert)
  #      - BASE_URL=https://mysite.com

  #        Respect proxy_pass type settings, `proxy_set_header Host "localhost";` and `proxy_set_header X-Forwarded-Prefix /app;`
  #        More here https://github.com/dgtlmoon/changedetection.io/wiki/Running-changedetection.io-behind-a-reverse-proxy-sub-directory
  #      - USE_X_SETTINGS=1
  #
  #        Hides the `Referer` header so that monitored websites can't see the changedetection.io hostname.
        - HIDE_REFERER=true

      # Comment out ports: when using behind a reverse proxy , enable networks: etc.
      #ports:
      #  - 5000:5000
      restart: unless-stopped

     # Used for fetching pages via WebDriver+Chrome where you need Javascript support.
     # Now working on arm64 (needs testing on rPi - tested on Oracle ARM instance)
     # replace image with seleniarm/standalone-chromium:4.0.0-20211213
     
     # If WEBDRIVER or PLAYWRIGHT are enabled, changedetection container depends on that
     # and must wait before starting (substitute "browser-chrome" with "playwright-chrome" if last one is used)
#      depends_on:
#        browser-chrome:
#            condition: service_started
      depends_on:
          sockpuppetbrowser:
              condition: service_started


    sockpuppetbrowser:
        hostname: sockpuppetbrowser
        image: dgtlmoon/sockpuppetbrowser:latest
        networks:
          - traefik_default
        cap_add:
            - SYS_ADMIN
## SYS_ADMIN might be too much, but it can be needed on your platform https://github.com/puppeteer/puppeteer/blob/main/docs/troubleshooting.md#running-puppeteer-on-gitlabci
        restart: unless-stopped
        environment:
            - SCREEN_WIDTH=1920
            - SCREEN_HEIGHT=1024
            - SCREEN_DEPTH=16
            - MAX_CONCURRENT_CHROME_PROCESSES=10
        #logging:
        #  driver: none

#    browser-chrome:
#        hostname: browser-chrome
#        #image: selenium/standalone-chrome-debug:3.141.59
#        image: selenium/standalone-chrome:4
#        networks:
#          - traefik_default
#        environment:
#            - VNC_NO_PASSWORD=1
#            - SCREEN_WIDTH=1920
#            - SCREEN_HEIGHT=1080
#            - SCREEN_DEPTH=24
#        volumes:
            # Workaround to avoid the browser crashing inside a docker container
            # See https://github.com/SeleniumHQ/docker-selenium#quick-start
            #            - /dev/shm:/dev/shm
#        restart: unless-stopped

     # Used for fetching pages via Playwright+Chrome where you need Javascript support.

        #    playwright-chrome:
        #hostname: playwright-chrome
        #image: browserless/chrome:latest
        #restart: unless-stopped
        #networks:
        #  - traefik_default
        #environment:
        #    - SCREEN_WIDTH=1920
        #    - SCREEN_HEIGHT=1024
        #    - SCREEN_DEPTH=16
        #    - ENABLE_DEBUGGER=false
        #    - PREBOOT_CHROME=true
        #    - CONNECTION_TIMEOUT=300000
        #    - MAX_CONCURRENT_SESSIONS=10
        #    - CHROME_REFRESH_TIME=600000
        #    - DEFAULT_BLOCK_ADS=true
        #    - DEFAULT_STEALTH=true

networks:
  traefik_default:
    external: true

volumes:
  changedetectionio_data:
    external: true
